@{
    ViewData["Title"] = "Báo cáo - Thống kê";
}

<h2>Báo cáo - Thống kê</h2>
<div id="message" class="alert" style="display:none;"></div>

<!-- Tabs cho các loại báo cáo -->
<ul class="nav nav-tabs" id="baoCaoTabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="doanhThu-tab" data-toggle="tab" href="#doanhThu" role="tab">Doanh thu</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="xuatKho-tab" data-toggle="tab" href="#xuatKho" role="tab">Xuất kho</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="tonKho-tab" data-toggle="tab" href="#tonKho" role="tab">Tồn kho</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="khachHang-tab" data-toggle="tab" href="#khachHang" role="tab">Khách hàng</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="nhanVien-tab" data-toggle="tab" href="#nhanVien" role="tab">Nhân viên</a>
    </li>
</ul>

<div class="tab-content" id="baoCaoTabContent">
    <!-- Doanh thu -->
    <div class="tab-pane fade show active" id="doanhThu" role="tabpanel">
        <div class="mt-3">
            <label>Loại thống kê:</label>
            <select id="loaiThongKe" class="form-control d-inline w-auto">
                <option value="ngay">Ngày</option>
                <option value="tuan">Tuần</option>
                <option value="thang">Tháng</option>
                <option value="nam">Năm</option>
            </select>
            <label>Từ ngày:</label>
            <input type="date" id="tuNgayDoanhThu" class="form-control d-inline w-auto" />
            <label>Đến ngày:</label>
            <input type="date" id="denNgayDoanhThu" class="form-control d-inline w-auto" />
            <button class="btn btn-primary" onclick="loadDoanhThu()">Xem</button>
        </div>
        <table class="table table-bordered mt-3" id="doanhThuTable">
            <thead>
                <tr><th>Thời gian</th><th>Tổng doanh thu</th></tr>
            </thead>
            <tbody id="doanhThuList"></tbody>
        </table>
    </div>

    <!-- Xuất kho -->
    <div class="tab-pane fade" id="xuatKho" role="tabpanel">
        <div class="mt-3">
            <label>Từ ngày:</label>
            <input type="date" id="tuNgayXuatKho" class="form-control d-inline w-auto" />
            <label>Đến ngày:</label>
            <input type="date" id="denNgayXuatKho" class="form-control d-inline w-auto" />
            <button class="btn btn-primary" onclick="loadXuatKho()">Xem</button>
        </div>
        <table class="table table-bordered mt-3" id="xuatKhoTable">
            <thead>
                <tr><th>Ngày</th><th>Tổng số lượng xuất</th><th>Chi tiết</th></tr>
            </thead>
            <tbody id="xuatKhoList"></tbody>
        </table>
    </div>

    <!-- Tồn kho -->
    <div class="tab-pane fade" id="tonKho" role="tabpanel">
        <button class="btn btn-primary mt-3" onclick="loadTonKho()">Xem</button>
        <table class="table table-bordered mt-3" id="tonKhoTable">
            <thead>
                <tr><th>Mã SP</th><th>Tên SP</th><th>Số lượng tồn</th><th>Hạn dùng</th><th>Trạng thái</th></tr>
            </thead>
            <tbody id="tonKhoList"></tbody>
        </table>
    </div>

    <!-- Khách hàng -->
    <div class="tab-pane fade" id="khachHang" role="tabpanel">
        <button class="btn btn-primary mt-3" onclick="loadKhachHang()">Xem</button>
        <table class="table table-bordered mt-3" id="khachHangTable">
            <thead>
                <tr><th>Mã KH</th><th>Tên KH</th><th>Tổng tiền</th><th>Số lần mua</th></tr>
            </thead>
            <tbody id="khachHangList"></tbody>
        </table>
    </div>

    <!-- Nhân viên -->
    <div class="tab-pane fade" id="nhanVien" role="tabpanel">
        <div class="mt-3">
            <label>Từ ngày:</label>
            <input type="date" id="tuNgayNhanVien" class="form-control d-inline w-auto" />
            <label>Đến ngày:</label>
            <input type="date" id="denNgayNhanVien" class="form-control d-inline w-auto" />
            <button class="btn btn-primary" onclick="loadNhanVien()">Xem</button>
        </div>
        <table class="table table-bordered mt-3" id="nhanVienTable">
            <thead>
                <tr><th>Mã NV</th><th>Tên NV</th><th>Số phiếu thu</th><th>Số phiếu xuất</th><th>Tổng doanh thu</th></tr>
            </thead>
            <tbody id="nhanVienList"></tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function loadDoanhThu() {
        var loai = $('#loaiThongKe').val();
        var tuNgay = $('#tuNgayDoanhThu').val();
        var denNgay = $('#denNgayDoanhThu').val();
        $.ajax({
            url: '@Url.Action("GetDoanhThu", "BaoCao")',
            type: 'GET',
            data: { loaiThongKe: loai, tuNgay: tuNgay, denNgay: denNgay },
            success: function (data) {
                var tbody = $('#doanhThuList').empty();
                data.forEach(function (item) {
                    tbody.append(`<tr><td>${item.thoiGian}</td><td>${item.tongDoanhThu}</td></tr>`);
                });
            }
        });
    }

    function loadXuatKho() {
        var tuNgay = $('#tuNgayXuatKho').val();
        var denNgay = $('#denNgayXuatKho').val();
        $.ajax({
            url: '@Url.Action("GetXuatKho", "BaoCao")',
            type: 'GET',
            data: { tuNgay: tuNgay, denNgay: denNgay },
            success: function (data) {
                var tbody = $('#xuatKhoList').empty();
                data.forEach(function (item) {
                    var chiTiet = item.chiTiet.map(ct => `${ct.sTenSp}: ${ct.iSlx}`).join(', ');
                    tbody.append(`<tr><td>${new Date(item.ngay).toLocaleDateString()}</td><td>${item.tongSoLuongXuat}</td><td>${chiTiet}</td></tr>`);
                });
            }
        });
    }

    function loadTonKho() {
        $.ajax({
            url: '@Url.Action("GetTonKho", "BaoCao")',
            type: 'GET',
            success: function (data) {
                var tbody = $('#tonKhoList').empty();
                data.forEach(function (item) {
                    tbody.append(`<tr><td>${item.pkSMaSp}</td><td>${item.sTenSp}</td><td>${item.iSl}</td><td>${new Date(item.sHanDung).toLocaleDateString()}</td><td>${item.trangThai}</td></tr>`);
                });
            }
        });
    }

    function loadKhachHang() {
        $.ajax({
            url: '@Url.Action("GetKhachHangMuaNhieu", "BaoCao")',
            type: 'GET',
            success: function (data) {
                var tbody = $('#khachHangList').empty();
                data.forEach(function (item) {
                    tbody.append(`<tr><td>${item.maKH}</td><td>${item.tenKH}</td><td>${item.tongTien}</td><td>${item.soLanMua}</td></tr>`);
                });
            }
        });
    }

    function loadNhanVien() {
        var tuNgay = $('#tuNgayNhanVien').val();
        var denNgay = $('#denNgayNhanVien').val();
        $.ajax({
            url: '@Url.Action("GetHieuSuatNhanVien", "BaoCao")',
            type: 'GET',
            data: { tuNgay: tuNgay, denNgay: denNgay },
            success: function (data) {
                var tbody = $('#nhanVienList').empty();
                data.forEach(function (item) {
                    tbody.append(`<tr><td>${item.maNV}</td><td>${item.tenNV}</td><td>${item.soPhieuThu}</td><td>${item.soPhieuXuat}</td><td>${item.tongDoanhThu}</td></tr>`);
                });
            }
        });
    }

    $(document).ready(function () {
        // Load mặc định khi mở trang
        loadDoanhThu();
        $('#baoCaoTabs a').on('shown.bs.tab', function (e) {
            var tab = $(e.target).attr('href');
            if (tab === '#doanhThu') loadDoanhThu();
            else if (tab === '#xuatKho') loadXuatKho();
            else if (tab === '#tonKho') loadTonKho();
            else if (tab === '#khachHang') loadKhachHang();
            else if (tab === '#nhanVien') loadNhanVien();
        });
    });
</script>